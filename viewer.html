<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGRS Solver - Output Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            background: #f5f5f5;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #eeeeee;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-align: center;
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .summary-card.hard {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .summary-card.soft {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-card.overall {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .summary-card.status {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
        }

        .violations-list {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .violations-list h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .violation-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .assignments-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .assignments-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .assignments-table tr:hover {
            background: #f5f5f5;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .employee-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .employee-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .employee-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-item .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .stat-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .warning {
            background: #ffe5e5;
            border-left: 4px solid #f5576c;
            color: #c92a2a;
        }

        .success {
            background: #e5ffe5;
            border-left: 4px solid #43e97b;
            color: #2f7c31;
        }

        .meta-info {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .meta-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .meta-info .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #667eea;
        }

        .info-value {
            color: #333;
            word-break: break-all;
        }

        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .timeline-date {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .timeline-details {
            color: #666;
            font-size: 0.95em;
        }

        /* Calendar View Styles */
        .calendar-view {
            margin-top: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calendar-grid {
            overflow-x: auto;
            margin-top: 20px;
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            border-right: 1px solid #5568d3;
        }

        .calendar-table th:first-child {
            text-align: left;
            min-width: 120px;
        }

        .calendar-table td {
            padding: 15px;
            border: 1px solid #e0e0e0;
            text-align: center;
            vertical-align: top;
            min-width: 150px;
            background: #f9f9f9;
        }

        .calendar-table tr:nth-child(even) td {
            background: #ffffff;
        }

        .calendar-table tr:hover td {
            background: #f0f4ff;
        }

        .assignment-cell {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            line-height: 1.4;
            display: inline-block;
            width: 100%;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .assignment-cell-empty {
            color: #ccc;
            font-size: 0.9em;
            font-style: italic;
        }

        .assignment-emp-id {
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
        }

        .assignment-shift {
            font-size: 0.8em;
            opacity: 0.9;
            display: block;
            margin-bottom: 2px;
        }

        .assignment-hours {
            font-size: 0.75em;
            opacity: 0.85;
            display: block;
        }

        .calendar-date-header {
            font-weight: 700;
            color: #667eea;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1 1 50%;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .filter-container {
                flex-direction: column;
            }

            .assignments-table {
                font-size: 0.9em;
            }

            .assignments-table th,
            .assignments-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä NGRS Solver Output Viewer</h1>
            <p>Interactive Dashboard for Workforce Scheduling Results</p>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 500;">Load Input File:</label>
                <input type="file" id="inputFileInput" accept=".json" style="display: none;">
                <button id="openInputFileBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9em;">üìÇ Open Input</button>
                <span id="loadedInputFileName" style="color: rgba(255,255,255,0.8); font-size: 0.9em;"></span>
                <span style="color: rgba(255,255,255,0.4); margin: 0 10px;">|</span>
                <label for="outputFileSelector" style="font-weight: 500;">Load Output File:</label>
                <select id="outputFileSelector" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 0.95em; cursor: pointer;">
                    <option value="">-- Select a file from output/ --</option>
                </select>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
                <button id="openFileBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9em;">üìÇ Open File</button>
                <span id="loadedFileName" style="color: rgba(255,255,255,0.8); font-size: 0.9em;"></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('input')">üìã Input Data</button>
            <button class="tab-button" onclick="switchTab('summary')">üìà Summary</button>
            <button class="tab-button" onclick="switchTab('assignments')">üë• Assignments</button>
            <button class="tab-button" onclick="switchTab('employees')">üë§ Employee Details</button>
            <button class="tab-button" onclick="switchTab('violations')">‚ö†Ô∏è Violations</button>
            <button class="tab-button" onclick="switchTab('timeline')">üìÖ Timeline</button>
            <button class="tab-button" onclick="switchTab('emptyslots')">üìä Demand Coverage</button>
            <button class="tab-button" onclick="switchTab('employeeroster')">üìÖ Employee Roster</button>
            <button class="tab-button" onclick="switchTab('metadata')">‚ÑπÔ∏è Metadata</button>
        </div>

        <!-- INPUT DATA TAB -->
        <div id="input" class="tab-content active">
            <div class="section-header">
                <h2>üìã Input Configuration</h2>
                <p>View demand items, requirements, rotation patterns, employees, and configuration</p>
            </div>

            <div id="inputContainer"></div>
        </div>

        <!-- SUMMARY TAB -->
        <div id="summary" class="tab-content">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Solver Status</h3>
                    <div class="value" id="status">-</div>
                </div>
                <div class="summary-card hard">
                    <h3>Hard Score</h3>
                    <div class="value" id="hardScore">0</div>
                </div>
                <div class="summary-card soft">
                    <h3>Soft Score</h3>
                    <div class="value" id="softScore">0</div>
                </div>
                <div class="summary-card overall">
                    <h3>Overall Score</h3>
                    <div class="value" id="overallScore">0</div>
                </div>
                <div class="summary-card status">
                    <h3>Total Assignments</h3>
                    <div class="value" id="totalAssignments">0</div>
                </div>
                <div class="summary-card status">
                    <h3>Duration (sec)</h3>
                    <div class="value" id="duration">0</div>
                </div>
            </div>

            <h2 style="margin: 30px 0 20px; color: #333;">Score Breakdown</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Hard Constraints</h3>
                    <div class="chart-container">
                        <canvas id="hardChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Soft Constraints</h3>
                    <div class="chart-container">
                        <canvas id="softChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ASSIGNMENTS TAB -->
        <div id="assignments" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">All Assignments</h2>
            <div class="filter-container">
                <input type="text" class="filter-input" id="employeeFilter" placeholder="üîç Filter by Employee ID">
                <input type="date" class="filter-input" id="dateFilter" placeholder="Filter by Date">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
            </div>

            <table class="assignments-table" id="assignmentsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Shift Code</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Gross (h)</th>
                        <th>Normal (h)</th>
                        <th>OT (h)</th>
                        <th>Lunch (h)</th>
                    </tr>
                </thead>
                <tbody id="assignmentsBody">
                </tbody>
            </table>
        </div>

        <!-- EMPLOYEES TAB -->
        <div id="employees" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Employee Details</h2>
            <div id="employeesContainer"></div>
        </div>

        <!-- VIOLATIONS TAB -->
        <div id="violations" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Constraint Violations</h2>
            <div id="violationsContainer"></div>
        </div>

        <!-- TIMELINE TAB -->
        <div id="timeline" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Assignment Timeline</h2>
            
            <div class="view-toggle">
                <button class="active" onclick="switchTimelineView('list')">üìã List View</button>
                <button onclick="switchTimelineView('calendar')">üìÖ Calendar Grid</button>
            </div>
            
            <div id="timelineContainer"></div>
            <div id="calendarContainer" style="display: none;"></div>
        </div>

        <!-- EMPTY SLOTS TAB -->
        <div id="emptyslots" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Empty Slots by Demand</h2>
            <div id="emptySlotsContainer"></div>
        </div>

        <!-- EMPLOYEE ROSTER TAB -->
        <div id="employeeroster" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Employee Roster</h2>
            <div id="employeeRosterContainer"></div>
        </div>

        <!-- METADATA TAB -->
        <div id="metadata" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Solver Metadata</h2>
            <div class="meta-info" id="metadataContainer"></div>
        </div>
    </div>

    <script>
        let outputData = null;
        let inputData = null;
        let filteredAssignments = [];
        let currentFile = null;
        let hardChartInstance = null;
        let softChartInstance = null;

        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Load available output files from server API
            loadAvailableFiles();
            
            // Setup file selector listener
            const outputFileSelector = document.getElementById('outputFileSelector');
            if (outputFileSelector) {
                outputFileSelector.addEventListener('change', (e) => {
                    const filePath = e.target.value;
                    if (filePath) {
                        loadOutputDataFromPath(filePath);
                    }
                });
            }
            
            // Setup file open button
            const openFileBtn = document.getElementById('openFileBtn');
            const fileInput = document.getElementById('fileInput');
            if (openFileBtn) {
                openFileBtn.addEventListener('click', () => {
                    fileInput.click();
                });
            }
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        loadOutputDataFromFile(file);
                    }
                });
            }
            
            // Setup input file open button
            const openInputFileBtn = document.getElementById('openInputFileBtn');
            const inputFileInput = document.getElementById('inputFileInput');
            if (openInputFileBtn) {
                openInputFileBtn.addEventListener('click', () => {
                    inputFileInput.click();
                });
            }
            if (inputFileInput) {
                inputFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        loadInputDataFromFile(file);
                    }
                });
            }
        });

        async function loadAvailableFiles() {
            try {
                const response = await fetch('/api/output-files');
                if (!response.ok) {
                    console.log('Server API not available - using local file picker');
                    return;
                }
                
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    const selector = document.getElementById('outputFileSelector');
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.path;
                        option.textContent = file.name;
                        selector.appendChild(option);
                    });
                    console.log(`Loaded ${data.files.length} output files`);
                }
            } catch (error) {
                console.log('Could not load file list from server API:', error);
                console.log('Note: Run server.py for better file browsing experience');
            }
        }

        async function loadOutputDataFromPath(filePath) {
            try {
                console.log(`Loading file: ${filePath}`);
                currentFile = filePath;
                
                // Extract filename from path (e.g., "output/output_1211_1502.json" -> "output_1211_1502.json")
                const filename = filePath.split('/').pop();
                const apiUrl = `/api/output-file/${filename}`;
                
                console.log(`Fetching from API: ${apiUrl}`);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                outputData = await response.json();
                console.log('Loaded data:', outputData);
                console.log('Assignments count:', outputData.assignments?.length);
                
                document.getElementById('loadedFileName').textContent = `Loaded: ${filename}`;
                renderDashboard();
            } catch (error) {
                console.error(`Error loading ${filePath}:`, error);
                alert(`Error loading file. Make sure server.py is running.\n\nError: ${error.message}`);
            }
        }

        function loadOutputDataFromFile(file) {
            try {
                console.log(`Loading file from dialog: ${file.name}`);
                currentFile = file.name;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        outputData = JSON.parse(e.target.result);
                        console.log('Loaded data from file:', outputData);
                        console.log('Assignments count:', outputData.assignments?.length);
                        
                        document.getElementById('loadedFileName').textContent = `Loaded: ${file.name}`;
                        renderDashboard();
                    } catch (parseError) {
                        console.error('Error parsing JSON:', parseError);
                        alert(`Error parsing JSON file: ${parseError.message}`);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Error reading file:', error);
                    alert(`Error reading file: ${error}`);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error(`Error loading file:`, error);
                alert(`Error loading file: ${error.message}`);
            }
        }

        function loadInputDataFromFile(file) {
            try {
                console.log(`Loading input file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        inputData = JSON.parse(e.target.result);
                        console.log('Loaded input data:', inputData);
                        
                        document.getElementById('loadedInputFileName').textContent = `Loaded: ${file.name}`;
                        renderInputData();
                    } catch (parseError) {
                        console.error('Error parsing input JSON:', parseError);
                        alert(`Error parsing JSON file: ${parseError.message}`);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Error reading input file:', error);
                    alert(`Error reading file: ${error}`);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error(`Error loading input file:`, error);
                alert(`Error loading file: ${error.message}`);
            }
        }

        function renderInputData() {
            if (!inputData) {
                console.error('No input data available');
                return;
            }

            const container = document.getElementById('inputContainer');
            container.innerHTML = '';

            // Planning horizon and basic info
            const horizon = inputData.planningHorizon || {};
            const publicHolidays = inputData.publicHolidays || [];
            
            let html = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Planning Reference</h3>
                        <div class="value" style="font-size: 0.8em;">${inputData.planningReference || 'N/A'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Planning Horizon</h3>
                        <div class="value" style="font-size: 0.9em;">${horizon.startDate || 'N/A'} to ${horizon.endDate || 'N/A'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Public Holidays</h3>
                        <div class="value" style="font-size: 0.9em;">${publicHolidays.length > 0 ? publicHolidays.join(', ') : 'None'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Employees</h3>
                        <div class="value">${(inputData.employees || []).length}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Demands</h3>
                        <div class="value">${(inputData.demandItems || []).length}</div>
                    </div>
                </div>
            `;

            // Demands and Requirements
            html += '<div class="section-header" style="margin-top: 30px;"><h3>üìã Demand Items & Requirements</h3></div>';
            
            const demands = inputData.demandItems || [];
            demands.forEach((demand, idx) => {
                const requirements = demand.requirements || [];
                const shifts = demand.shifts || [];
                
                html += `
                    <div class="employee-card" style="margin-bottom: 20px;">
                        <h3 style="color: #667eea;">${demand.demandId || `Demand ${idx + 1}`}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div><strong>Location:</strong> ${demand.locationId || 'N/A'}</div>
                            <div><strong>OU:</strong> ${demand.ouId || 'N/A'}</div>
                            <div><strong>Shift Start:</strong> ${demand.shiftStartDate || 'N/A'}</div>
                        </div>
                `;
                
                // Shift details
                if (shifts.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><strong>Shift Definitions:</strong></div>';
                    shifts.forEach((shift, sidx) => {
                        const shiftDetails = shift.shiftDetails || [];
                        const coverageDays = shift.coverageDays || [];
                        const coverageDaysStr = Array.isArray(coverageDays) ? coverageDays.join(', ') : coverageDays;
                        const coverageDaysCount = Array.isArray(coverageDays) ? coverageDays.length : 0;
                        html += `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 0.9em;">
                                    <div><strong>Coverage Days:</strong> <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; font-weight: 600;">${coverageDaysStr} (${coverageDaysCount} Days)</span></div>
                                    <div><strong>Include PH:</strong> ${shift.includePublicHolidays !== undefined ? shift.includePublicHolidays : 'N/A'}</div>
                                    <div><strong>Include Eve PH:</strong> ${shift.includeEveOfPublicHolidays !== undefined ? shift.includeEveOfPublicHolidays : 'N/A'}</div>
                                </div>
                                <div style="margin-top: 8px;">
                                    ${shiftDetails.map(sd => `
                                        <span style="display: inline-block; background: #667eea; color: white; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 0.85em;">
                                            ${sd.shiftCode}: ${sd.start}-${sd.end}${sd.nextDay ? ' +1' : ''}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Requirements table
                if (requirements.length > 0) {
                    html += `
                        <div style="margin-top: 15px;">
                            <strong>Requirements (${requirements.length}):</strong>
                            <div style="overflow-x: auto; margin-top: 10px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr style="background: #f0f0f0;">
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Req ID</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Product Type</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Rank</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Headcount</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Gender</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Scheme</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Rotation</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Qualifications</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    requirements.forEach(req => {
                        const rotation = (req.workPattern || req.rotationSequence || []).join(' - ');
                        const quals = req.requiredQualifications || [];
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.requirementId || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.productTypeId || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.rankId || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${req.headcount || 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.gender || 'Any'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.Scheme || 'Global'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${rotation}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.85em;">${quals.join(', ') || 'None'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            });

            // Employees
            html += '<div class="section-header" style="margin-top: 30px;"><h3>üë• Employees</h3></div>';
            
            const employees = inputData.employees || [];
            if (employees.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
                
                employees.forEach(emp => {
                    const qualifications = emp.qualifications || [];
                    html += `
                        <div class="employee-card">
                            <h3 style="color: #667eea;">${emp.employeeId || 'N/A'}</h3>
                            <div style="margin-bottom: 10px;">
                                <div><strong>Rank:</strong> ${emp.rankId || 'N/A'}</div>
                                <div><strong>Product Type:</strong> ${emp.productTypeId || 'N/A'}</div>
                                <div><strong>Team:</strong> ${emp.teamId || 'N/A'}</div>
                                <div><strong>OU:</strong> ${emp.ouId || 'N/A'}</div>
                                <div><strong>Scheme:</strong> ${emp.scheme || 'N/A'}</div>
                                <div><strong>Gender:</strong> ${emp.gender || 'N/A'}</div>
                                <div><strong>Rotation Offset:</strong> ${emp.rotationOffset !== undefined ? emp.rotationOffset : 'N/A'}</div>
                            </div>
                            ${qualifications.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <strong>Qualifications:</strong>
                                    <div style="margin-top: 5px;">
                                        ${qualifications.map(q => `
                                            <div style="background: #f0f0f0; padding: 5px; border-radius: 3px; margin: 3px 0; font-size: 0.85em;">
                                                <strong>${q.code}</strong><br>
                                                Valid: ${q.validFrom} ‚Üí ${q.expiryDate}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="no-data">No employees defined</div>';
            }

            // Constraints
            html += '<div class="section-header" style="margin-top: 30px;"><h3>‚öôÔ∏è Constraints</h3></div>';
            
            const constraints = inputData.constraintList || [];
            if (constraints.length > 0) {
                const hardConstraints = constraints.filter(c => c.enforcement === 'hard');
                const softConstraints = constraints.filter(c => c.enforcement === 'soft');
                
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                
                html += `
                    <div>
                        <h4 style="color: #f5576c; margin-bottom: 10px;">Hard Constraints (${hardConstraints.length})</h4>
                        <div style="background: #fff5f5; padding: 15px; border-radius: 8px;">
                            ${hardConstraints.map(c => `
                                <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong style="color: #f5576c;">${c.id}</strong><br>
                                    <span style="font-size: 0.85em; color: #666;">${c.description || 'No description'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: #4ecdc4; margin-bottom: 10px;">Soft Constraints (${softConstraints.length})</h4>
                        <div style="background: #f0fcfc; padding: 15px; border-radius: 8px;">
                            ${softConstraints.map(c => `
                                <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong style="color: #4ecdc4;">${c.id}</strong><br>
                                    <span style="font-size: 0.85em; color: #666;">${c.description || 'No description'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                html += '</div>';
            } else {
                html += '<div class="no-data">No constraints defined</div>';
            }

            container.innerHTML = html;
        }

        function renderDashboard() {
            if (!outputData) {
                console.error('No output data available');
                return;
            }

            console.log('Rendering dashboard...');
            try {
                renderSummary();
                console.log('Summary rendered');
                renderAssignments();
                console.log('Assignments rendered');
                renderEmployees();
                console.log('Employees rendered');
                renderViolations();
                console.log('Violations rendered');
                renderTimeline();
                console.log('Timeline rendered');
                renderEmptySlots();
                console.log('Empty Slots rendered');
                renderEmployeeRoster();
                console.log('Employee Roster rendered');
                renderMetadata();
                console.log('Metadata rendered');
            } catch (error) {
                console.error('Error rendering dashboard:', error);
                alert(`Error rendering dashboard: ${error.message}`);
            }
        }

        function renderSummary() {
            const score = outputData.score || {};
            const solverRun = outputData.solverRun || {};

            document.getElementById('status').textContent = solverRun.status || 'UNKNOWN';
            document.getElementById('hardScore').textContent = score.hard || 0;
            document.getElementById('softScore').textContent = score.soft || 0;
            document.getElementById('overallScore').textContent = score.overall || 0;
            document.getElementById('totalAssignments').textContent = outputData.assignments?.length || 0;
            document.getElementById('duration').textContent = (solverRun.durationSeconds || 0).toFixed(2);

            // Destroy existing chart instances
            if (hardChartInstance) {
                hardChartInstance.destroy();
            }
            if (softChartInstance) {
                softChartInstance.destroy();
            }

            // Create score charts
            const hardViolations = outputData.scoreBreakdown?.hard?.violations || [];
            const hardChartCtx = document.getElementById('hardChart').getContext('2d');
            hardChartInstance = new Chart(hardChartCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Violations: ${hardViolations.length}`,
                        `Satisfied`
                    ],
                    datasets: [{
                        data: [
                            hardViolations.length,
                            Math.max(0, 10 - hardViolations.length)
                        ],
                        backgroundColor: ['#f5576c', '#43e97b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Soft score chart
            const softChart = document.getElementById('softChart');
            if (softChart) {
                const softChartCtx = softChart.getContext('2d');
                softChartInstance = new Chart(softChartCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Soft Score'],
                        datasets: [{
                            label: 'Penalty',
                            data: [Math.abs(score.soft || 0)],
                            backgroundColor: '#4facfe',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        function renderAssignments() {
            const assignments = outputData.assignments || [];
            filteredAssignments = assignments;

            const tbody = document.getElementById('assignmentsBody');
            tbody.innerHTML = '';

            if (assignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No assignments available</td></tr>';
                return;
            }

            assignments.forEach(a => {
                const hours = a.hours || {};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${a.date || '-'}</td>
                    <td><strong>${a.employeeId || '-'}</strong></td>
                    <td>${a.shiftCode || '-'}</td>
                    <td>${a.startDateTime ? new Date(a.startDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    <td>${a.endDateTime ? new Date(a.endDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    <td>${hours.gross !== undefined ? hours.gross.toFixed(1) : '-'}</td>
                    <td>${hours.normal !== undefined ? hours.normal.toFixed(1) : '-'}</td>
                    <td><strong style="color: #f5576c;">${hours.ot !== undefined ? hours.ot.toFixed(1) : '0.0'}</strong></td>
                    <td>${hours.lunch !== undefined ? hours.lunch.toFixed(1) : '0.0'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderEmployees() {
            const employeeHours = outputData.meta?.employeeHours || {};
            const container = document.getElementById('employeesContainer');
            container.innerHTML = '';

            if (Object.keys(employeeHours).length === 0) {
                container.innerHTML = '<div class="no-data">No employee data available</div>';
                return;
            }

            Object.entries(employeeHours).forEach(([empId, data]) => {
                const card = document.createElement('div');
                card.className = 'employee-card';

                const weeklyHours = Object.values(data.weekly_normal || {}).reduce((a, b) => a + b, 0);
                const monthlyOt = Object.values(data.monthly_ot || {}).reduce((a, b) => a + b, 0);

                card.innerHTML = `
                    <h3>${empId}</h3>
                    <div class="employee-stats">
                        <div class="stat-item">
                            <div class="label">Total Normal Hours</div>
                            <div class="value">${weeklyHours.toFixed(1)}h</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Monthly OT (Total)</div>
                            <div class="value">${monthlyOt.toFixed(1)}h</div>
                            <div style="font-size: 0.8em; color: #999;">${monthlyOt <= 72 ? '‚úì OK' : '‚úó OVER'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Weekly Breakdown</div>
                            <div style="font-size: 0.9em; text-align: left;">
                                ${Object.entries(data.weekly_normal || {}).map(([week, hours]) =>
                                    `<div>${week}: ${hours.toFixed(1)}h ${hours <= 44 ? '‚úì' : '‚úó OVER'}</div>`
                                ).join('') || '<div style="color: #999;">No data</div>'}
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Monthly OT Breakdown</div>
                            <div style="font-size: 0.9em; text-align: left;">
                                ${Object.entries(data.monthly_ot || {}).map(([month, hours]) =>
                                    `<div>${month}: ${hours.toFixed(1)}h</div>`
                                ).join('') || '<div style="color: #999;">No OT</div>'}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderViolations() {
            const hard = outputData.scoreBreakdown?.hard?.violations || [];
            const softData = outputData.scoreBreakdown?.soft || {};
            const softDetails = softData.details || [];
            const container = document.getElementById('violationsContainer');
            container.innerHTML = '';

            if (hard.length === 0 && softDetails.length === 0) {
                container.innerHTML = '<div class="no-data success">‚úì No violations detected!</div>';
                return;
            }

            if (hard.length > 0) {
                const div = document.createElement('div');
                div.className = 'violations-list warning';
                div.innerHTML = `
                    <h4>‚ö†Ô∏è Hard Constraint Violations (${hard.length})</h4>
                    ${hard.map(v => `
                        <div class="violation-item">
                            <strong>${v.id || v.constraint || 'Unknown'}</strong>: ${v.note || v.message || 'No description'}
                        </div>
                    `).join('')}
                `;
                container.appendChild(div);
            }

            if (softDetails.length > 0) {
                const div = document.createElement('div');
                div.className = 'violations-list';
                div.innerHTML = `
                    <h4>üìå Soft Constraints (Total: ${softData.totalPenalty || 0} penalty)</h4>
                    ${softDetails.map(detail => `
                        <div class="violation-item">
                            <strong>${detail.constraint || detail.name || 'Unknown'}</strong>: ${detail.penalty || 0} penalty
                            ${detail.note || detail.message ? `<br><small>${detail.note || detail.message}</small>` : ''}
                        </div>
                    `).join('')}
                `;
                container.appendChild(div);
            }
        }

        function renderTimeline() {
            const assignments = outputData.assignments || [];
            const sorted = [...assignments].sort((a, b) => 
                new Date(a.startDateTime) - new Date(b.startDateTime)
            );

            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';

            if (sorted.length === 0) {
                container.innerHTML = '<div class="no-data">No assignments</div>';
                return;
            }

            sorted.forEach(a => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                const start = new Date(a.startDateTime);
                const end = new Date(a.endDateTime);
                const reqInfo = a.requirementId ? ` ‚Ä¢ Req: ${a.requirementId}` : '';

                item.innerHTML = `
                    <div class="timeline-date">${a.date} - ${a.shiftCode} (${a.demandId || 'N/A'}${reqInfo})</div>
                    <div class="timeline-details">
                        <strong>${a.employeeId}</strong> | 
                        ${start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Üí 
                        ${end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} 
                        (${(a.hours?.normal || 0).toFixed(1)}h normal, ${(a.hours?.ot || 0).toFixed(1)}h OT)
                    </div>
                `;
                container.appendChild(item);
            });

            // Also render calendar view
            renderCalendarView();
        }

        function renderCalendarView() {
            const assignments = outputData.assignments || [];

            if (assignments.length === 0) {
                document.getElementById('calendarContainer').innerHTML = '<div class="no-data">No assignments</div>';
                return;
            }

            // Group assignments by employee and date
            const assignmentsByEmployee = {};
            assignments.forEach(a => {
                if (!assignmentsByEmployee[a.employeeId]) {
                    assignmentsByEmployee[a.employeeId] = {};
                }
                assignmentsByEmployee[a.employeeId][a.date] = a;
            });

            // Get sorted dates and employees
            const allDates = [...new Set(assignments.map(a => a.date))].sort();
            const employees = Object.keys(assignmentsByEmployee).sort();

            // Create calendar table with dates as columns
            let html = '<div class="calendar-grid"><table class="calendar-table"><thead><tr>';
            html += '<th class="calendar-date-header">Employee</th>';

            // Date column headers
            allDates.forEach(date => {
                html += `<th class="calendar-date-header">${date}</th>`;
            });

            html += '</tr></thead><tbody>';

            // Fill in employees (rows) and their assignments by date (columns)
            employees.forEach(emp => {
                html += '<tr>';
                html += `<td class="calendar-date-header"><strong>${emp}</strong></td>`;

                allDates.forEach(date => {
                    const assignment = assignmentsByEmployee[emp][date];

                    if (assignment) {
                        const start = new Date(assignment.startDateTime);
                        const end = new Date(assignment.endDateTime);
                        const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const normal = (assignment.hours?.normal || 0).toFixed(1);
                        const ot = (assignment.hours?.ot || 0).toFixed(1);
                        
                        // Determine shift type for color coding
                        let cellStyle = '';
                        const shiftCode = (assignment.shiftCode || '').toUpperCase();
                        if (shiftCode.includes('D')) {
                            cellStyle = 'background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);'; // Day shift - orange to blue
                        } else if (shiftCode.includes('N')) {
                            cellStyle = 'background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);'; // Night shift - dark blue to light blue
                        } else if (shiftCode === 'O') {
                            cellStyle = 'background: #e0e0e0; color: #999;'; // Off day - gray
                        }
                        
                        const reqInfo = assignment.requirementId ? `<br><span style="font-size: 0.85em; opacity: 0.8;">Req: ${assignment.requirementId}</span>` : '';

                        html += `<td>
                            <div class="assignment-cell" style="${cellStyle}">
                                <span class="assignment-shift">${assignment.shiftCode} - ${assignment.demandId || 'N/A'}${reqInfo}</span>
                                <span class="assignment-hours">${startTime}‚Äì${endTime}</span>
                                <span class="assignment-hours">${normal}h N / ${ot}h OT</span>
                            </div>
                        </td>`;
                    } else {
                        html += `<td style="background: #f5f5f5;"><div class="assignment-cell-empty">‚Äî</div></td>`;
                    }
                });

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function switchTimelineView(view) {
            const timelineContainer = document.getElementById('timelineContainer');
            const calendarContainer = document.getElementById('calendarContainer');
            const buttons = document.querySelectorAll('.view-toggle button');

            if (view === 'list') {
                timelineContainer.style.display = 'block';
                calendarContainer.style.display = 'none';
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                timelineContainer.style.display = 'none';
                calendarContainer.style.display = 'block';
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        }

        function renderEmptySlots() {
            const container = document.getElementById('emptySlotsContainer');
            
            if (!outputData || !outputData.assignments) {
                container.innerHTML = '<p style="color: #999;">No assignment data available</p>';
                return;
            }

            const assignments = outputData.assignments;
            
            // Get public holidays from output data
            const publicHolidays = new Set(outputData.publicHolidays || []);
            
            // Build a map of all demands and dates from assignments
            const demandMap = {};
            const allDatesSet = new Set();
            
            assignments.forEach(a => {
                if (!demandMap[a.demandId]) {
                    demandMap[a.demandId] = {
                        demandId: a.demandId,
                        requirements: {},  // v0.70: Group by requirement
                        assignments: []
                    };
                }
                demandMap[a.demandId].assignments.push(a);
                
                // Group by requirement ID (v0.70 schema)
                const reqId = a.requirementId || 'default';
                if (!demandMap[a.demandId].requirements[reqId]) {
                    demandMap[a.demandId].requirements[reqId] = [];
                }
                demandMap[a.demandId].requirements[reqId].push(a);
                
                allDatesSet.add(a.date);
            });

            // Generate complete date range including off days
            let allDates = Array.from(allDatesSet).sort();
            
            if (allDates.length === 0) {
                container.innerHTML = '<p style="color: #999;">No assignments found</p>';
                return;
            }
            
            // Expand date range to include all days between first and last assignment
            const firstDate = new Date(allDates[0]);
            const lastDate = new Date(allDates[allDates.length - 1]);
            const completeDateRange = [];
            for (let d = new Date(firstDate); d <= lastDate; d.setDate(d.getDate() + 1)) {
                completeDateRange.push(d.toISOString().split('T')[0]);
            }
            allDates = completeDateRange;

            // Build assignment map by demand and date
            const assignmentsByDemandDate = {};
            Object.keys(demandMap).forEach(demandId => {
                assignmentsByDemandDate[demandId] = {};
                demandMap[demandId].assignments.forEach(a => {
                    if (!assignmentsByDemandDate[demandId][a.date]) {
                        assignmentsByDemandDate[demandId][a.date] = [];
                    }
                    assignmentsByDemandDate[demandId][a.date].push(a);
                });
            });

            // Render calendar grid showing assignments by demand
            let html = '<div style="overflow-x: auto;">';
            html += `<p style="margin-bottom: 20px; color: #666; font-size: 1.1em;">
                <strong>Demand Coverage View</strong> - Shows which slots are filled for each demand
            </p>`;
            html += '<table style="border-collapse: collapse; width: 100%; min-width: 800px;">';
            
            // Header row with dates
            html += '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f8f9fa; padding: 12px; border: 1px solid #ddd; min-width: 150px; z-index: 10;">Demand ID</th>';
            allDates.forEach(date => {
                const d = new Date(date);
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isPublicHoliday = publicHolidays.has(date);
                const headerBg = isPublicHoliday ? '#ffebee' : '#f8f9fa';
                const headerBorder = isPublicHoliday ? '2px solid #f44336' : '1px solid #ddd';
                html += `<th style="padding: 12px; border: ${headerBorder}; background: ${headerBg}; font-size: 0.85em; min-width: 140px;">
                    ${isPublicHoliday ? 'üéâ ' : ''}${dayName}<br>${dateStr}
                </th>`;
            });
            html += '</tr></thead><tbody>';

            // Rows for each demand (with requirements as sub-rows)
            Object.entries(assignmentsByDemandDate).forEach(([demandId, dateMap]) => {
                const demand = demandMap[demandId];
                const requirements = demand ? demand.requirements : {};
                const requirementIds = Object.keys(requirements);
                
                // If multiple requirements, show demand header + requirement rows
                if (requirementIds.length > 1) {
                    // Demand header row (spans all dates)
                    html += '<tr style="background: #e3f2fd;">';
                    html += `<td colspan="${allDates.length + 1}" style="padding: 8px 12px; border: 1px solid #ddd; font-weight: bold; font-size: 1.05em;">
                        üìã ${demandId} <span style="color: #666; font-weight: normal; font-size: 0.9em;">(${requirementIds.length} requirements)</span>
                    </td>`;
                    html += '</tr>';
                    
                    // Row for each requirement
                    requirementIds.forEach(reqId => {
                        html += '<tr>';
                        html += `<td style="position: sticky; left: 0; background: white; padding: 8px 12px 8px 24px; border: 1px solid #ddd; font-weight: 500; z-index: 5; font-size: 0.95em;">
                            ‚Ü≥ Req: ${reqId}
                        </td>`;
                        
                        allDates.forEach(date => {
                            const reqAssignments = requirements[reqId].filter(a => a.date === date);
                            const isPublicHoliday = publicHolidays.has(date);
                            html += renderAssignmentCell(reqAssignments, isPublicHoliday, date);
                        });
                        
                        html += '</tr>';
                    });
                } else {
                    // Single requirement or no requirement info - show as before
                    html += '<tr>';
                    html += `<td style="position: sticky; left: 0; background: white; padding: 12px; border: 1px solid #ddd; font-weight: bold; z-index: 5;">
                        ${demandId}
                    </td>`;

                    allDates.forEach(date => {
                        const assignments = dateMap[date] || [];
                        const isPublicHoliday = publicHolidays.has(date);
                        html += renderAssignmentCell(assignments, isPublicHoliday, date);
                    });

                    html += '</tr>';
                }
            });
            
            // Helper function to render assignment cells (extracted for reuse)
            function renderAssignmentCell(assignments, isPublicHoliday, date) {
                let cellHtml = '';
                
                if (assignments.length > 0) {
                    // Check if any assignment has no employee (unfilled slot)
                    const hasUnfilledSlot = assignments.some(a => !a.employeeId || a.employeeId === '' || a.employeeId === 'UNASSIGNED');
                    
                    // Determine cell background based on unfilled status
                    let cellBg, cellBorder;
                    if (hasUnfilledSlot) {
                        // Unfilled slot - use red background
                        cellBg = '#ffcdd2';
                        cellBorder = '2px solid #d32f2f';
                    } else if (isPublicHoliday) {
                        cellBg = '#ffebee';
                        cellBorder = '1px solid #f44336';
                    } else {
                        cellBg = '#e8f5e9';
                        cellBorder = '1px solid #ddd';
                    }
                    
                    cellHtml += `<td style="padding: 4px; border: ${cellBorder}; background: ${cellBg}; vertical-align: top;">`;
                    
                    assignments.forEach(assignment => {
                        // Check if this is an unfilled slot
                        if (!assignment.employeeId || assignment.employeeId === '' || assignment.employeeId === 'UNASSIGNED') {
                            // Unfilled slot - red background with warning
                            const reqId = assignment.requirementId || 'N/A';
                            cellHtml += `<div style="background: #d32f2f; color: white; padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; box-shadow: 0 2px 4px rgba(211,47,47,0.3);">
                                <div style="font-weight: bold;">‚ùå Req:${reqId}, ${assignment.shiftCode || 'N/A'}</div>
                                <div style="margin-top: 2px; opacity: 0.95;">UNFILLED</div>
                                <div style="font-size: 0.8em; opacity: 0.85; margin-top: 2px;">Slot: ${(assignment.slotId || 'N/A').substring(0, 20)}...</div>
                            </div>`;
                        } else {
                            // Normal filled assignment
                            const start = new Date(assignment.startDateTime);
                            const end = new Date(assignment.endDateTime);
                            const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const normal = (assignment.hours?.normal || 0).toFixed(1);
                            const ot = (assignment.hours?.ot || 0).toFixed(1);
                            const reqId = assignment.requirementId || 'N/A';
                            
                            // Determine shift type for color coding
                            let cellStyle = 'background: #c8e6c9; border-left: 4px solid #4caf50;'; // Green for filled
                            const shiftCode = (assignment.shiftCode || '').toUpperCase();
                            if (shiftCode.includes('D')) {
                                cellStyle = 'background: #e3f2fd; border-left: 4px solid #2196f3;'; // Blue for day
                            } else if (shiftCode.includes('N')) {
                                cellStyle = 'background: #e8eaf6; border-left: 4px solid #3f51b5;'; // Indigo for night
                            }
                            
                            cellHtml += `<div style="${cellStyle} padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em;">
                                <div style="font-weight: bold; color: #2e7d32;">‚úì Req:${reqId}, ${assignment.shiftCode}</div>
                                <div style="color: #1565c0; font-weight: 600; margin-top: 2px;">${assignment.employeeId}</div>
                                <div style="color: #555; margin-top: 2px;">${startTime}‚Äì${endTime}</div>
                                <div style="color: #666; font-size: 0.9em;">${normal}h N / ${ot}h OT</div>
                            </div>`;
                        }
                    });
                    
                    cellHtml += '</td>';
                } else {
                    // No assignment for this demand/requirement on this date - show off day
                    const cellBg = isPublicHoliday ? '#fff3e0' : '#f5f5f5';
                    const cellBorder = isPublicHoliday ? '1px solid #ff9800' : '1px solid #ddd';
                    cellHtml += `<td style="padding: 8px; border: ${cellBorder}; background: ${cellBg}; text-align: center; vertical-align: middle;">`;
                    cellHtml += `<div style="color: #999; font-size: 0.9em; font-weight: 500;">${isPublicHoliday ? 'üéâ Holiday' : 'O'}</div>`;
                    if (isPublicHoliday) {
                        cellHtml += '<div style="color: #f57c00; font-size: 0.75em; margin-top: 2px;">Public Holiday</div>';
                    } else {
                        cellHtml += '<div style="color: #bbb; font-size: 0.75em; margin-top: 2px;">Off Day</div>';
                    }
                    cellHtml += '</td>';
                }
                
                return cellHtml;
            }

            html += '</tbody></table></div>';
            html += `<p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <strong>‚ÑπÔ∏è Note:</strong> This view shows filled assignments grouped by demand. 
                Cells with "‚Äî" indicate no assignments for that demand on that date. 
                To see truly empty slots (unfilled demand requirements), the input JSON file would be needed.
            </p>`;
            container.innerHTML = html;
        }

        function renderEmployeeRoster() {
            const container = document.getElementById('employeeRosterContainer');
            
            if (!outputData || !outputData.assignments) {
                container.innerHTML = '<p style="color: #999;">No assignment data available</p>';
                return;
            }

            const assignments = outputData.assignments;
            
            // Get public holidays from output data
            const publicHolidays = new Set(outputData.publicHolidays || []);
            
            // Group assignments by employee
            const assignmentsByEmployee = {};
            const allDatesSet = new Set();
            
            assignments.forEach(a => {
                const empId = a.employeeId || 'UNASSIGNED';
                if (!assignmentsByEmployee[empId]) {
                    assignmentsByEmployee[empId] = [];
                }
                assignmentsByEmployee[empId].push(a);
                allDatesSet.add(a.date);
            });

            // Generate complete date range including off days
            let allDates = Array.from(allDatesSet).sort();
            
            if (allDates.length === 0) {
                container.innerHTML = '<p style="color: #999;">No assignments found</p>';
                return;
            }
            
            // Expand date range to include all days between first and last assignment
            const firstDate = new Date(allDates[0]);
            const lastDate = new Date(allDates[allDates.length - 1]);
            const completeDateRange = [];
            for (let d = new Date(firstDate); d <= lastDate; d.setDate(d.getDate() + 1)) {
                completeDateRange.push(d.toISOString().split('T')[0]);
            }
            allDates = completeDateRange;

            // Build assignment map by employee and date
            const assignmentsByEmployeeDate = {};
            Object.keys(assignmentsByEmployee).forEach(empId => {
                assignmentsByEmployeeDate[empId] = {};
                assignmentsByEmployee[empId].forEach(a => {
                    if (!assignmentsByEmployeeDate[empId][a.date]) {
                        assignmentsByEmployeeDate[empId][a.date] = [];
                    }
                    assignmentsByEmployeeDate[empId][a.date].push(a);
                });
            });

            // Calculate totals for each employee
            const employeeTotals = {};
            Object.entries(assignmentsByEmployee).forEach(([empId, empAssignments]) => {
                let totalNormal = 0;
                let totalOT = 0;
                empAssignments.forEach(a => {
                    totalNormal += (a.hours?.normal || 0);
                    totalOT += (a.hours?.ot || 0);
                });
                employeeTotals[empId] = { normal: totalNormal, ot: totalOT };
            });

            // Render calendar grid showing assignments by employee
            let html = '<div style="overflow-x: auto;">';
            html += `<p style="margin-bottom: 20px; color: #666; font-size: 1.1em;">
                <strong>Employee Roster View</strong> - Shows each employee's assignments, off days, and total hours
            </p>`;
            html += '<table style="border-collapse: collapse; width: 100%; min-width: 800px;">';
            
            // Header row with dates
            html += '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f8f9fa; padding: 12px; border: 1px solid #ddd; min-width: 150px; z-index: 10;">Employee ID</th>';
            allDates.forEach(date => {
                const d = new Date(date);
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isPublicHoliday = publicHolidays.has(date);
                const headerBg = isPublicHoliday ? '#ffebee' : '#f8f9fa';
                const headerBorder = isPublicHoliday ? '2px solid #f44336' : '1px solid #ddd';
                html += `<th style="padding: 12px; border: ${headerBorder}; background: ${headerBg}; font-size: 0.85em; min-width: 140px;">
                    ${isPublicHoliday ? 'üéâ ' : ''}${dayName}<br>${dateStr}
                </th>`;
            });
            html += '<th style="position: sticky; right: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; min-width: 120px; z-index: 10; font-weight: bold;">Total Hours</th>';
            html += '</tr></thead><tbody>';

            // Rows for each employee
            const sortedEmployees = Object.keys(assignmentsByEmployeeDate).sort();
            sortedEmployees.forEach(empId => {
                const dateMap = assignmentsByEmployeeDate[empId];
                const totals = employeeTotals[empId];
                
                html += '<tr>';
                html += `<td style="position: sticky; left: 0; background: white; padding: 12px; border: 1px solid #ddd; font-weight: bold; z-index: 5;">
                    ${empId}
                </td>`;

                allDates.forEach(date => {
                    const assignments = dateMap[date] || [];
                    const isPublicHoliday = publicHolidays.has(date);
                    
                    if (assignments.length > 0) {
                        // Show filled assignments
                        const hasUnfilledSlot = assignments.some(a => !a.employeeId || a.employeeId === '' || a.employeeId === 'UNASSIGNED');
                        
                        let cellBg, cellBorder;
                        if (hasUnfilledSlot) {
                            cellBg = '#ffcdd2';
                            cellBorder = '2px solid #d32f2f';
                        } else if (isPublicHoliday) {
                            cellBg = '#ffebee';
                            cellBorder = '1px solid #f44336';
                        } else {
                            cellBg = '#e8f5e9';
                            cellBorder = '1px solid #ddd';
                        }
                        
                        html += `<td style="padding: 4px; border: ${cellBorder}; background: ${cellBg}; vertical-align: top;">`;
                        
                        assignments.forEach(assignment => {
                            const start = new Date(assignment.startDateTime);
                            const end = new Date(assignment.endDateTime);
                            const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const normal = (assignment.hours?.normal || 0).toFixed(1);
                            const ot = (assignment.hours?.ot || 0).toFixed(1);
                            
                            // Determine shift type for color coding
                            let cellStyle = 'background: #c8e6c9; border-left: 4px solid #4caf50;';
                            const shiftCode = (assignment.shiftCode || '').toUpperCase();
                            if (shiftCode.includes('D')) {
                                cellStyle = 'background: #e3f2fd; border-left: 4px solid #2196f3;';
                            } else if (shiftCode.includes('N')) {
                                cellStyle = 'background: #e8eaf6; border-left: 4px solid #3f51b5;';
                            }
                            
                            const reqId = assignment.requirementId || 'N/A';
                            html += `<div style="${cellStyle} padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em;">
                                <div style="font-weight: bold; color: #2e7d32;">Req:${reqId}, ${assignment.shiftCode}</div>
                                <div style="color: #555; margin-top: 2px;">${startTime}‚Äì${endTime}</div>
                                <div style="color: #666; font-size: 0.9em;">${normal}h N${ot > 0 ? ` / ${ot}h OT` : ''}</div>
                            </div>`;
                        });
                        
                        html += '</td>';
                    } else {
                        // No assignment for this employee on this date - show off day
                        const cellBg = isPublicHoliday ? '#fff3e0' : '#f5f5f5';
                        const cellBorder = isPublicHoliday ? '1px solid #ff9800' : '1px solid #ddd';
                        html += `<td style="padding: 8px; border: ${cellBorder}; background: ${cellBg}; text-align: center; vertical-align: middle;">`;
                        html += `<div style="color: #999; font-size: 0.9em; font-weight: 500;">${isPublicHoliday ? 'üéâ Holiday' : 'O'}</div>`;
                        if (isPublicHoliday) {
                            html += '<div style="color: #f57c00; font-size: 0.75em; margin-top: 2px;">Public Holiday</div>';
                        } else {
                            html += '<div style="color: #bbb; font-size: 0.75em; margin-top: 2px;">Off Day</div>';
                        }
                        html += '</td>';
                    }
                });
                
                // Add totals column
                html += `<td style="position: sticky; right: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; z-index: 5; text-align: center;">`;
                html += `<div style="font-weight: bold; color: #1565c0; font-size: 0.95em;">${totals.normal.toFixed(1)}h N</div>`;
                if (totals.ot > 0) {
                    html += `<div style="font-weight: bold; color: #d32f2f; font-size: 0.95em; margin-top: 4px;">${totals.ot.toFixed(1)}h OT</div>`;
                }
                html += '</td>';

                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            html += `<p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <strong>‚ÑπÔ∏è Legend:</strong> 
                <span style="background: #e3f2fd; padding: 4px 8px; border-left: 4px solid #2196f3; margin: 0 8px;">D = Day Shift</span>
                <span style="background: #e8eaf6; padding: 4px 8px; border-left: 4px solid #3f51b5; margin: 0 8px;">N = Night Shift</span>
                <span style="color: #999; margin: 0 8px;">O = Off Day</span>
                <span style="color: #f57c00; margin: 0 8px;">üéâ = Public Holiday</span>
            </p>`;
            container.innerHTML = html;
        }

        function renderMetadata() {
            const meta = outputData.meta || {};
            const solverRun = outputData.solverRun || {};

            const container = document.getElementById('metadataContainer');
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Schema Version</span>
                    <span class="info-value">${outputData.schemaVersion || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Solver Version</span>
                    <span class="info-value">${solverRun.solverVersion || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status</span>
                    <span class="info-value">${solverRun.status || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Started</span>
                    <span class="info-value">${new Date(solverRun.startedAt).toLocaleString() || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ended</span>
                    <span class="info-value">${new Date(solverRun.ended).toLocaleString() || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Duration</span>
                    <span class="info-value">${solverRun.durationSeconds?.toFixed(3)}s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Input Hash</span>
                    <span class="info-value" style="font-family: monospace; font-size: 0.9em;">${meta.inputHash || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Generated</span>
                    <span class="info-value">${new Date(meta.generatedAt).toLocaleString() || '-'}</span>
                </div>
            `;
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function clearFilters() {
            document.getElementById('employeeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filterAssignments();
        }

        function filterAssignments() {
            const empId = document.getElementById('employeeFilter').value.toUpperCase();
            const date = document.getElementById('dateFilter').value;

            const tbody = document.getElementById('assignmentsBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowEmpId = cells[1].textContent.toUpperCase();
                const rowDate = cells[0].textContent;

                const empMatch = !empId || rowEmpId.includes(empId);
                const dateMatch = !date || rowDate === date;

                row.style.display = empMatch && dateMatch ? '' : 'none';
            });
        }

        document.getElementById('employeeFilter')?.addEventListener('keyup', filterAssignments);
        document.getElementById('dateFilter')?.addEventListener('change', filterAssignments);
    </script>
</body>
</html>
